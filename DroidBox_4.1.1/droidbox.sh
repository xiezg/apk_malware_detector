#!/bin/bash

cd $(dirname $(readlink -f $0))

function usage()
{
cat << EOF
	usage: $0 options

	OPTIONS:
		-h: Show this message
		-f: APK file
		-r: result save path
		-a: url to post. e.g. http://localhost/api/repair
		-s: get current state 0:busy !0:free
EOF
}

APK_FILE=
RESULE_PATH=
POST_URL=
PID_FILE=/tmp/droidbox.pid

while getopts "hf:r:a:s" OPTION
do
	case $OPTION in
		h)
		usage
		exit 0
		;;
		f)
		APK_FILE=$OPTARG
		;;
		r)
		RESULE_PATH=$OPTARG
		;;
		a)
		POST_URL=$OPTARG
		;;
		s)
		tmp_pid=`cat $PID_FILE 2>/dev/null`
		if [ -z "$tmp_pid" ];then exit 1; fi
		ps --pid $tmp_pid >/dev/null
		exit $?
		;;
		?)
		usage
		exit 1
		;;
	esac

done

if [[ -z $APK_FILE ]] || [[ -z $RESULE_PATH ]] || [[ -z $POST_URL ]];then
	usage
	exit 1
fi

LOG_FILENAME=/tmp/$(basename $APK_FILE).log

echo $$ > $PID_FILE

echo 'start drodibox.py' >$LOG_FILENAME

python "scripts/droidbox.py" $APK_FILE $RESULE_PATH $POST_URL #>>$LOG_FILENAME

echo 'end droidbox.py' >>$LOG_FILENAME


